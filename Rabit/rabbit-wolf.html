<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>Document</title>
  </head>
  <body>
    <div id="container"></div>
    <button id="start">New Board</button>

    <script>
      const FREE_CELL = 0
      const RABBIT = "Rabbit"
      const WOLF = "wOLF"
      const FENCE = 3
      const HOME = "Home"
      const X = 0
      const Y = 1
      let boardNumber = 0
      const IMAGES = {
        [RABBIT]: "img/rabbit.gif",
        [WOLF]: "img/gamewolf.png",
        [FENCE]: "img/ban.png",
        [HOME]: "img/home.png",
      }

      const startButton = document.getElementById("start")

      startButton.onclick = newGame

      function creatDiv(name, boardNumber) {
        const div = document.createElement("div")
        div.id = name + "-" + boardNumber
        div.setAttribute("class", name)
        return div
      }
      function creatButton(name, boardNumber) {
        const btn = document.createElement("button")
        btn.setAttribute("class", name)
        btn.id = name + "-" + boardNumber
        btn.innerHTML = name + "-" + boardNumber
        return btn
      }
      function newGame() {
        function startGame() {
          const findTheStartingGame = getMoveElement("start-", boardNumber)
          const value = document.getElementById("select-" + boardNumber).value
          const array = createMatrix(value)

          const gameState = {
            gameMatrix: array,
            gameContinue: true,
            gameResult: "",
            gamNumber: boardNumber,
          }
          const wolfCount = Math.ceil((60 * value) / 100)
          const fenceCount = Math.round((40 * value) / 100)
          defineAtributes(gameState, wolfCount, fenceCount, boardNumber)
          sizeThePlayingField(gameState)
          drawAPlayingField(gameState.gameMatrix, boardNumber)
          drawBtn(gameState, boardNumber)
          eventKeys(gameState, boardNumber)
        }
        const container = document.getElementById("container")
        boardNumber++
        startButton.style.display = "none"
        const newGameArea = creatDiv("newGameArea", boardNumber)
        const newDiv = creatDiv("newBoard", boardNumber)
        const btnEvent = creatDiv("btnEvent", boardNumber)
        container.append(newDiv, newGameArea, btnEvent)

        const buttonStart = creatButton("start", boardNumber)
        const selectList = document.createElement("select")
        selectList.id = "select-" + boardNumber
        selectList.classList = "select"
        const valueSizeArray = ["5", "7", "10"]
        const optionText = ["5X5", "7X7", "10x10"]
        for (var i = 0; i < valueSizeArray.length; i++) {
          let option = document.createElement("option")
          option.value = valueSizeArray[i]
          option.text = optionText[i]
          selectList.appendChild(option)
        }
        const newBoardButton = creatButton("NewBoard", boardNumber)
        newDiv.append(buttonStart, selectList, newBoardButton)
        buttonStart.onclick = startGame
        newBoardButton.onclick = newGame
      }

      function defineRandomPosition(arr, character, boardNumber) {
        const x = Math.floor(Math.random() * arr.length)
        const y = Math.floor(Math.random() * arr.length)
        if (arr[x][y] === FREE_CELL) {
          arr[x][y] = character
        } else {
          defineRandomPosition(arr, character, boardNumber)
        }
      }

      function defineAtributes(gameState, wolfCount, fenceCount, boardNumber) {
        if (gameState.gameResult) {
          return
        } else {
          defineRabbit(gameState.gameMatrix, boardNumber)
          defineWolves(gameState.gameMatrix, wolfCount, boardNumber)
          defineFences(gameState.gameMatrix, fenceCount, boardNumber)
          defineHome(gameState.gameMatrix, boardNumber)
          console.log(gameState.gameMatrix, boardNumber)
        }
      }

      function defineFences(array, count) {
        for (i = 1; i < count; i++) {
          defineFence(array)
        }
      }

      function defineWolves(array, wolfCount) {
        for (i = 0; i < wolfCount; i++) {
          defineWolf(array)
        }
      }
      function IndexWolfes(array) {
        for (i = 0; i < array.length; i++) {
          console.log(array[i])
        }
      }
      const defineRabbit = (array, boardNumber) =>
        defineRandomPosition(array, RABBIT)
      const defineFence = (array, boardNumber) =>
        defineRandomPosition(array, FENCE)
      const defineWolf = (array, boardNumber) =>
        defineRandomPosition(array, WOLF)
      const defineHome = (array, boardNumber) =>
        defineRandomPosition(array, HOME)

      function createMatrix(value) {
        let arr = []
        for (let i = 0; i < value; i++) {
          arr[i] = []
          for (let j = 0; j < value; j++) {
            arr[i][j] = FREE_CELL
          }
        }
        return arr
      }

      function findCordinateCharacter(array, character) {
        const findeMtrix = function (accumulator, row, x) {
          row.forEach((cell, y) => {
            if (cell === character) {
              accumulator.push([x, y])
            }
          })
          return accumulator
        }
        return array.reduce(findeMtrix, [])
      }

      function rabbitGoTo(gameState, rabbitIndex, x, y) {
        const array = gameState.gameMatrix
        const [i, j] = rabbitIndex
        if (array[x][y] === FREE_CELL) {
          array[x][y] = RABBIT
          array[i][j] = FREE_CELL
          console.log(array)
        }
        if (array[x][y] === HOME) {
          array[x][y] = HOME
          array[i][j] = RABBIT
          changeGameStatus(gameState, "win")
          return
        }

        if (array[x][y] === WOLF) {
          array[x][y] = WOLF
          array[i][j] = RABBIT
          changeGameStatus(gameState, "gameOver")
          return
        }
      }

      function getDirectionCoord(gameState, rabbitIndex, eventKey) {
        const array = gameState.gameMatrix
        let [x, y] = rabbitIndex
        let newX = x
        let newY = y
        const arraySize = array.length - 1
        if (eventKey === "ArrowRight") {
          newY = y + 1
          if (y === arraySize) {
            newY = 0
          }
        } else if (eventKey === "ArrowLeft") {
          newY = y - 1
          if (y === 0) {
            newY = arraySize
          }
        } else if (eventKey === "ArrowUp") {
          newX = x - 1
          if (x === 0) {
            newX = arraySize
          }
        } else if (eventKey === "ArrowDown") {
          newX = x + 1
          if (x === arraySize) {
            newX = 0
          }
        }

        return [newX, newY]
      }

      function getNearCellsOf(index) {
        const [x, y] = index
        return [
          [x - 1, y],
          [x, y + 1],
          [x + 1, y],
          [x, y - 1],
        ]
      }
      function isInRange(array, [x, y]) {
        if (x != array.length && x >= 0 && y != array.length && y >= 0) {
          return true
        }
      }

      function findTheStepNearTheRabbit(gameState, index) {
        const array = gameState.gameMatrix
        function isLegitim(cell) {
          const legitimCells = [FREE_CELL, RABBIT]

          return legitimCells.includes(array[cell[X]][cell[Y]])
        }

        function _isInRange(cell) {
          return isInRange(array, cell)
        }
        return getNearCellsOf(index).filter(_isInRange).filter(isLegitim)
      }

      function minStepcordinate(rabbitIndex, wolfIndex) {
        const [x1, y1] = rabbitIndex
        const [x2, y2] = wolfIndex
        return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2))
      }

      function moveWolves(gameState, rabbitIndex) {
        const array = gameState.gameMatrix
        const wolfsIndex = findCordinateCharacter(gameState.gameMatrix, WOLF)

        const moveWolf = (wolf) => {
          if (gameState.gameContinue === false) {
            changeGameStatus(gameState, "gameOver")
            return
          }
          const steps = findTheStepNearTheRabbit(gameState, wolf)
          if (steps.length > 0) {
            steps.forEach((step) => {
              if (array[step[0]][step[1]] === RABBIT) {
                console.log("hi")
                changeGameStatus(gameState, "gameOver")
                return
              }
            })
            const distances = steps.map((step) =>
              minStepcordinate(rabbitIndex, step)
            )
            const index = distances.indexOf(Math.min(...distances))
            const nearPoint = steps[index]
            if (nearPoint === RABBIT) {
              changeGameStatus(gameState, "gameOver")
              return
            }
            array[nearPoint[X]][nearPoint[Y]] = WOLF
            array[wolf[X]][wolf[Y]] = FREE_CELL
          }
        }

        wolfsIndex.forEach(moveWolf)
      }

      function deleteThePlayingField() {
        const container = document.getElementById("newGameArea-" + boardNumber)
        container.innerHTML = " "
        const btn = document.getElementById("btnEvent-" + boardNumber)
        btn.innerHTML = " "
      }

      function sizeThePlayingField(gameState) {
        const width = gameState.length * 80 + 100 + "px"
        const playingFieldDiv = document.getElementById(
          "newGameArea-" + boardNumber
        )
        playingFieldDiv.style.width = width
      }

      function appendElementsInnerDivs(index) {
        const container = document.getElementById("newGameArea-" + boardNumber)
        const div = document.createElement("div")
        div.setAttribute("id", index + boardNumber)
        div.setAttribute("class", "box")
        container.append(div)
      }

      function addPicturesOnThePlayingField(character, index) {
        const div = document.getElementById(index + boardNumber)
        const img = document.createElement("img")
        img.src = IMAGES[character]
        div.append(img)
      }

      function drawAPlayingField(gameState, boardNumber) {
        sizeThePlayingField(gameState, boardNumber)
        gameState.forEach((row, x) => {
          row.forEach((cell, y) => {
            const index = [x, y]

            appendElementsInnerDivs(index)

            if (cell === RABBIT) {
              addPicturesOnThePlayingField(RABBIT, index)
            }
            if (cell === WOLF) {
              addPicturesOnThePlayingField(WOLF, index)
            }
            if (cell === FENCE) {
              addPicturesOnThePlayingField(FENCE, index)
            }
            if (cell === HOME) {
              addPicturesOnThePlayingField(HOME, index)
            }
          })
        })
      }

      function displayOfTheFinal(gameState) {
        if (gameState.gameResult === "win") {
          alert("Congratulations! You Won!")
        }
        if (gameState.gameResult === "gameOver") {
          alert("You Lost")
        }
        deleteThePlayingField()
      }

      function changeGameStatus(gameState, status) {
        gameState.gameContinue = false
        gameState.gameResult = status
        console.log(status)
      }

      function drawBtn(gameState, boardNumber) {
        const container = document.getElementById("container")
        const btnContainer = document.getElementById("btnEvent-" + boardNumber)

        const btnUp = creatButton("up", boardNumber)
        const btnRight = creatButton("right", boardNumber)
        const btnDown = creatButton("down", boardNumber)
        const btnLeft = creatButton("left", boardNumber)

        btnContainer.append(btnUp, btnLeft, btnRight, btnDown)

        container.append(btnContainer)
      }

      function eventKeysFunctions(gameState, eventKey) {
        deleteThePlayingField()
        console.log(eventKey)
        const rabbitIndex = findCordinateCharacter(
          gameState.gameMatrix,
          RABBIT
        )[0]
        const [x, y] = rabbitIndex

        const [newX, newY] = getDirectionCoord(gameState, rabbitIndex, eventKey)
        rabbitGoTo(gameState, rabbitIndex, newX, newY)
        if (gameState.gameContinue === false) {
          displayOfTheFinal(gameState)
          //   const container = document.getElementById("btnEvent")
          //   container.innerHTML = ""
          return
        }
        moveWolves(gameState, rabbitIndex)
        if (gameState.gameContinue === false) {
          displayOfTheFinal(gameState)
          //   const container = document.getElementById("btnEvent")
          //   container.innerHTML = ""
          return
        }

        drawAPlayingField(gameState.gameMatrix)
        drawBtn(gameState, boardNumber)
        eventKeys(gameState, boardNumber)
      }

      function getMoveElement(name, boardNumber) {
        return document.getElementById(name + boardNumber)
      }

      function eventKeys(gameState, boardNumber) {
        function ArrowUp() {
          eventKeysFunctions(gameState, "ArrowUp")
        }
        function ArrowRight() {
          eventKeysFunctions(gameState, "ArrowRight")
        }
        function ArrowDown() {
          eventKeysFunctions(gameState, "ArrowDown")
        }

        function ArrowLeft() {
          eventKeysFunctions(gameState, "ArrowLeft")
        }
        getMoveElement("up-", boardNumber).addEventListener("click", ArrowUp)
        getMoveElement("down-", boardNumber).addEventListener(
          "click",
          ArrowDown
        )
        getMoveElement("left-", boardNumber).addEventListener(
          "click",
          ArrowLeft
        )
        getMoveElement("right-", boardNumber).addEventListener(
          "click",
          ArrowRight
        )
      }
    </script>
  </body>
</html>
