<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>Document</title>
  </head>
  <body>
    <button id="btn">Start</button>
    <select id="select">
      <option value="5">5 X 5</option>
      <option value="7">7 X 7</option>
      <option value="10">10 X 10</option>
    </select>
    <div id="container"></div>
    <script>
      const FREE_CELL = 0
      const RABBIT = "Rabbit"
      const WOLF = "wOLF"
      const FENCE = 3
      const HOME = "Home"
      const X = 0
      const Y = 1

      const IMAGES = {
        [RABBIT]: "img/rabbit.gif",
        [WOLF]: "img/gamewolf.png",
        [FENCE]: "img/ban.png",
        [HOME]: "img/home.png",
      }

      const btn = document.getElementById("btn")
      btn.onclick = startGame

      function startGame() {
        deleteThePlayingField()
        document.getElementById("container").style.display = "flex"

        const value = document.getElementById("select").value
        const array = createMatrix(value)

        const gameState = {
          gameMatrix: array,
          gameContinue: true,
          gameResult: "",
        }

        const wolfCount = Math.ceil((60 * value) / 100)
        const fenceCount = Math.round((40 * value) / 100)

        defineAtributes(gameState, wolfCount, fenceCount)

        eventLisener(gameState)

        drawAPlayingField(gameState.gameMatrix)
      }

      function eventLisener(gameState) {
        function startMoveRabbit(eventKey) {
          if (gameState.gameContinue === false) {
            window.removeEventListener("keyup", startMoveRabbit)
            return
          }
          const rabbitIndex = findCordinateCharacter(
            gameState.gameMatrix,
            RABBIT
          )[0]
          const [x, y] = rabbitIndex

          const [newX, newY] = getDirectionCoord(
            gameState,
            rabbitIndex,
            event.key
          )
          rabbitGoTo(gameState, rabbitIndex, newX, newY)
          console.log(gameState.gameContinue)
          console.log(gameState.gameResult)
          if (gameState.gameContinue === false) {
            displayOfTheFinal(gameState)
            return
          } else {
            moveWolves(gameState, rabbitIndex)
            console.log(gameState.gameContinue)
            console.log(gameState.gameResult)
            if (gameState.gameContinue === false) {
              displayOfTheFinal(gameState)
              return
            } else {
              deleteThePlayingField()
              drawAPlayingField(gameState.gameMatrix)
            }
          }
        }
        window.addEventListener("keyup", startMoveRabbit)
      }

      function defineRandomPosition(arr, character) {
        const x = Math.floor(Math.random() * arr.length)
        const y = Math.floor(Math.random() * arr.length)
        if (arr[x][y] === FREE_CELL) {
          arr[x][y] = character
        } else {
          defineRandomPosition(arr, character)
        }
      }

      function defineAtributes(gameState, wolfCount, fenceCount) {
        if (gameState.gameResult) {
          return
        } else {
          defineRabbit(gameState.gameMatrix)
          defineWolves(gameState.gameMatrix, wolfCount)
          defineFences(gameState.gameMatrix, fenceCount)
          defineHome(gameState.gameMatrix)
          console.log(gameState.gameMatrix)
        }
      }

      function defineFences(array, count) {
        for (i = 1; i < count; i++) {
          defineFence(array)
        }
      }

      function defineWolves(array, wolfCount) {
        for (i = 0; i < wolfCount; i++) {
          defineWolf(array)
        }
      }
      function IndexWolfes(array) {
        for (i = 0; i < array.length; i++) {
          console.log(array[i])
        }
      }
      const defineRabbit = (array) => defineRandomPosition(array, RABBIT)
      const defineFence = (array) => defineRandomPosition(array, FENCE)
      const defineWolf = (array) => defineRandomPosition(array, WOLF)
      const defineHome = (array) => defineRandomPosition(array, HOME)

      function createMatrix(value) {
        let arr = []
        for (let i = 0; i < value; i++) {
          arr[i] = []
          for (let j = 0; j < value; j++) {
            arr[i][j] = FREE_CELL
          }
        }
        return arr
      }

      function findCordinateCharacter(array, character) {
        const findeMtrix = function (accumulator, row, x) {
          row.forEach((cell, y) => {
            if (cell === character) {
              accumulator.push([x, y])
            }
          })
          return accumulator
        }
        return array.reduce(findeMtrix, [])
      }

      function rabbitGoTo(gameState, rabbitIndex, x, y) {
        const array = gameState.gameMatrix
        const [i, j] = rabbitIndex
        if (array[x][y] === FREE_CELL) {
          array[x][y] = RABBIT
          array[i][j] = FREE_CELL
          console.log(array)
        }
        if (array[x][y] === HOME) {
          array[x][y] = HOME
          array[i][j] = RABBIT
          changeGameStatus(gameState, "win")
          return
        }

        if (array[x][y] === WOLF) {
          array[x][y] = WOLF
          array[i][j] = RABBIT
          changeGameStatus(gameState, "gameOver")
          return
        }
      }

      function getDirectionCoord(gameState, rabbitIndex, eventKey) {
        const array = gameState.gameMatrix
        let [x, y] = rabbitIndex
        let newX = x
        let newY = y
        const arraySize = array.length - 1
        if (eventKey === "ArrowRight") {
          newY = y + 1
          if (y === arraySize) {
            newY = 0
          }
        } else if (eventKey === "ArrowLeft") {
          newY = y - 1
          if (y === 0) {
            newY = arraySize
          }
        } else if (eventKey === "ArrowUp") {
          newX = x - 1
          if (x === 0) {
            newX = arraySize
          }
        } else if (eventKey === "ArrowDown") {
          newX = x + 1
          if (x === arraySize) {
            newX = 0
          }
        }

        return [newX, newY]
      }

      function findTheEmptyBoxes(gameState, index) {
        const array = gameState.gameMatrix
        const [x, y] = index
        const up = [x - 1, y]
        const down = [x + 1, y]
        const right = [x, y + 1]
        const left = [x, y - 1]
        let steps = [up, down, right, left]

        steps = steps.filter(
          (move) =>
            move[X] >= 0 &&
            move[X] < array.length &&
            move[Y] >= 0 &&
            move[Y] < array.length
        )
        let findRebbitNearWolf = steps.filter(
          (step) => array[step[X]][step[Y]] === RABBIT
        )

        if (findRebbitNearWolf.length !== 0) {
          changeGameStatus(gameState, "gameOver")
          return
        } else {
          return steps.filter((step) => array[step[X]][step[Y]] === FREE_CELL)
        }
      }

      function minStepcordinate(rabbitIndex, wolfIndex) {
        const [x1, y1] = rabbitIndex
        const [x2, y2] = wolfIndex
        return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2))
      }

      function moveWolves(gameState, rabbitIndex) {
        const array = gameState.gameMatrix
        const wolfsIndex = findCordinateCharacter(gameState.gameMatrix, WOLF)

        const moveWolf = (wolf) => {
          if (gameState.gameContinue === false) {
            changeGameStatus(gameState, "gameOver")
            return
          }
          const steps = findTheEmptyBoxes(gameState, wolf)
          if (steps !== undefined) {
            const distances = steps.map((step) =>
              minStepcordinate(rabbitIndex, step)
            )
            const index = distances.indexOf(Math.min(...distances))
            const nearPoint = steps[index]
            array[nearPoint[X]][nearPoint[Y]] = WOLF
            array[wolf[X]][wolf[Y]] = FREE_CELL
          }
        }

        wolfsIndex.forEach(moveWolf)
      }

      function deleteThePlayingField() {
        const container = document.getElementById("container")
        container.innerHTML = " "
      }

      function sizeThePlayingField(array) {
        const width = array.length * 80 + 100 + "px"
        const playingFieldDiv = document.getElementById("container")
        playingFieldDiv.style.width = width
      }

      function appendElementsInnerDivs(index) {
        const container = document.getElementById("container")

        const div = document.createElement("div")
        div.setAttribute("id", index)
        div.setAttribute("class", "box")
        container.append(div)
      }

      function addPicturesOnThePlayingField(character, index) {
        const div = document.getElementById(index)
        const img = document.createElement("img")
        img.src = IMAGES[character]
        div.append(img)
      }

      function drawAPlayingField(array) {
        sizeThePlayingField(array)
        array.forEach((row, x) => {
          row.forEach((cell, y) => {
            const index = [x, y]
            if (cell === FREE_CELL) {
              appendElementsInnerDivs(index)
            }
            if (cell === RABBIT) {
              appendElementsInnerDivs(index)
              addPicturesOnThePlayingField(RABBIT, index)
            }
            if (cell === WOLF) {
              appendElementsInnerDivs(index)
              addPicturesOnThePlayingField(WOLF, index)
            }
            if (cell === FENCE) {
              appendElementsInnerDivs(index)
              addPicturesOnThePlayingField(FENCE, index)
            }
            if (cell === HOME) {
              appendElementsInnerDivs(index)
              addPicturesOnThePlayingField(HOME, index)
            }
          })
        })
      }

      function displayOfTheFinal(gameState) {
        if (gameState.gameResult === "win") {
          alert("Congratulations! You Won!")
        } else {
          alert("You Lost")
        }
        deleteThePlayingField()
        document.getElementById("container").style.display = "none"
      }

      function changeGameStatus(gameState, status) {
        gameState.gameContinue = false
        gameState.gameResult = status
      }
    </script>
  </body>
</html>
